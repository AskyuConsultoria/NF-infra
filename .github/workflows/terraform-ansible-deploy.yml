name: Terraform + Ansible Deploy + Inventory S3

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      AWS_DEFAULT_REGION: us-east-1
      TF_VAR_aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
      TF_VAR_aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      TF_VAR_aws_session_token: ${{ secrets.AWS_SESSION_TOKEN }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}

    steps:
      # 1ï¸âƒ£ Checkout do repositÃ³rio
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Setup Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.5

      # 3ï¸âƒ£ Instalar Ansible, AWS CLI e dependÃªncias
      - name: Install Ansible & dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y python3-pip jq unzip sshpass
          pip3 install --upgrade pip
          pip3 install ansible awscli boto3 botocore
          ansible-galaxy collection install community.docker
          aws --version
          ansible --version

      # 4ï¸âƒ£ Inicializar Terraform
      - name: Terraform Init
        run: terraform init

      # 5ï¸âƒ£ Aplicar Terraform
      - name: Terraform Apply
        run: |
          terraform apply -var-file="envs/dev.tfvars" \
            -var "aws_access_key_id=${{ secrets.AWS_ACCESS_KEY_ID }}" \
            -var "aws_secret_access_key=${{ secrets.AWS_SECRET_ACCESS_KEY }}" \
            -var "aws_session_token=${{ secrets.AWS_SESSION_TOKEN }}" \
            -auto-approve

      # 6ï¸âƒ£ Capturar outputs do Terraform
      - name: Get Terraform Outputs
        id: tf_outputs
        run: |
          PUBLIC_IP=($(terraform output -json bastion_public_ip | jq -r '.[0][]'))
          PRIVATE_IP=($(terraform output -json private_instance_ip | jq -r '.[0][]'))
          DB_IP=$(terraform output -raw db_instance_ip)
          RAW_UNS_BUCKET_NAME=$(terraform output -raw unstructured-bucket-name)

          echo "PUBLIC_IP=${PUBLIC_IP[@]}" >> $GITHUB_ENV
          echo "PRIVATE_IP=${PRIVATE_IP[@]}" >> $GITHUB_ENV
          echo "DB_IP=$DB_IP" >> $GITHUB_ENV
          echo "RAW_UNS_BUCKET_NAME=$RAW_UNS_BUCKET_NAME" >> $GITHUB_ENV

      # 7ï¸âƒ£ Adicionar fingerprints SSH
      - name: Add SSH Known Hosts
        run: |
          mkdir -p ~/.ssh
          for ip in $PUBLIC_IP; do
            ssh-keyscan -H "$ip" >> ~/.ssh/known_hosts
          done

      # 8ï¸âƒ£ Enviar chaves privadas para instÃ¢ncias
      - name: Send Private Keys to Instances
        run: |
          for i in "${!PUBLIC_IP[@]}"; do
            PUB_IP="${PUBLIC_IP[$i]}"
            PRIV_IP="${PRIVATE_IP[$i]}"
            scp -i ~/.ssh/pbkey-ges -o StrictHostKeyChecking=no ~/.ssh/pvkey-ges "ubuntu@$PUB_IP:~"
            ssh -i ~/.ssh/pbkey-ges "ubuntu@$PUB_IP" "ssh-keyscan -H $PRIV_IP" >> ~/.ssh/known_hosts
          done
          ssh -i ~/.ssh/pbkey-ges "ubuntu@${PUBLIC_IP[0]}" "ssh-keyscan -H $DB_IP" >> ~/.ssh/known_hosts

      # 9ï¸âƒ£ Upload do inventory.ini para o S3
      - name: Upload inventory.ini to S3
        run: |
          aws s3 cp inventory.ini s3://$RAW_UNS_BUCKET_NAME/inventory.ini
          echo "https://$RAW_UNS_BUCKET_NAME.s3.amazonaws.com/inventory.ini" > inventory_url.txt

      # ğŸ”¹ Upload da URL como artifact
      - name: Upload inventory URL artifact
        uses: actions/upload-artifact@v4
        with:
          name: inventory-url
          path: inventory_url.txt

      # ğŸ”Ÿ Rodar Playbooks do Ansible
      - name: Run Ansible Playbooks
        run: |
          ansible-playbook -i inventory.ini deploy-config.yaml
          ansible-playbook -i inventory.ini deploy-bd.yaml
          ansible-playbook -i inventory.ini deploy-backend.yaml
          ansible-playbook -i inventory.ini deploy-frontend.yaml

      # 1ï¸âƒ£1ï¸âƒ£ Summary final
      - name: Summary
        run: |
          echo "âœ… Infraestrutura criada com sucesso!"
          echo "ğŸŒ IP PÃºblico: $PUBLIC_IP"
          echo "ğŸ”’ IP Privado: $PRIVATE_IP"
          echo "ğŸª£ Bucket RAW: $RAW_UNS_BUCKET_NAME"
          echo "ğŸ”— Inventory URL: https://$RAW_UNS_BUCKET_NAME.s3.amazonaws.com/inventory.ini"
